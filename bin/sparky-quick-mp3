#!/bin/bash

# Create by Elton 2019/01/24
# Last update 2019/01/29 by pavroo

# get default's locale file
DEFLOCDIR="/usr/share/sparky/sparky-tube"
if [ "`cat /etc/default/locale | grep pl`" != "" ]; then
. $DEFLOCDIR/pl
elif [ "`cat /etc/default/locale | grep pt_BR`" != "" ]; then
. $DEFLOCDIR/pt_BR
else
. $DEFLOCDIR/en
fi

GUI="yad --center --window-icon=/usr/share/icons/sparky/about/sparky48.png --image=multimedia-audio-player --image-on-top --width=400 --title="
FORM="--form"
INFO="--info"
PROGRESS="--progress --pulsate --auto-close --no-buttons --auto-kill --text="
FIELD="--field="
TXT="--text="
BUTTON="--button=Ok!gtk-ok:0"
BTNPLAY="--button=$LOCAL10!cancel:1 --button=$LOCAL9!gtk-ok:0"
FILESELECT="--file --file-filter=*.mp3"
  
if [ ! -e /usr/bin/youtube-dl ] 
then	
	INSTALL=$($GUI"Sparky MP3" $INFO $TXT"$LOCAL1")
	if [ "$?" != 0 ]
	then
		exit 1
	else
		if [ -f /usr/bin/sparky-xterm ]
		then
			SPARKYXTERM="/usr/bin/sparky-xterm"
		else
			echo "sparky-xterm is missing... Exiting..."
			exit 1
		fi
		$SPARKYXTERM "sudo apt-get install youtube-dl"		
	fi	
fi

URL=$($GUI"Sparky MP3" $FORM $TXT"$LOCAL2\n" $FIELD"<b>URL</b>:" $BUTTON | cut -d "|" -f1)

#check url
CHECKURL=$(curl -o /dev/null --silent --head --write-out '%{http_code}' "$URL")

if [ $CHECKURL -eq 200 ]
then
	DIR=$($GUI"Sparky MP3" $FORM $TXT"$LOCAL3\n" $FIELD"Local:":DIR $BUTTON | cut -d "|" -f1)
	cd $DIR		
	youtube-dl -it --extract-audio --audio-format mp3 --audio-quality 0 $URL | BAR=$($GUI"Sparky MP3" $PROGRESS"$LOCAL5")
	
	$GUI"Sparky MP3" $INFO $TXT"$LOCAL11" $BUTTON
	
	$GUI"Sparky MP3" $INFO $TXT"$LOCAL12" $BTNPLAY
	if [[ "$?" = "0" ]]
	then
		FILE=$($GUI"Sparky MP3" $FORM $TXT"$LOCAL13\n" $FILESELECT $BUTTON | cut -d "|" -f1)
		xdg-open "$FILE"
	else
		exit 0		
	fi	
else
	$GUI"Sparky MP3" $INFO $TXT"$LOCAL4" $BUTTON
fi

exit 0
