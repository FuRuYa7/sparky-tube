#!/bin/bash

# Created by Elton 2019/01/24
# Contributors: Elton, pavroo, Sajmon
# Last update 2019/02/15
# License: GNU GPL 3 

# get default's locale file
DEFLOCDIR="/usr/share/sparky/sparky-tube"
if grep -Eqs 'de' /etc/default/locale; then
. $DEFLOCDIR/de
elif grep -Eqs 'fr' /etc/default/locale; then
. $DEFLOCDIR/fr  
elif grep -Eqs 'pl' /etc/default/locale; then
. $DEFLOCDIR/pl
elif grep -Eqs 'pt_BR' /etc/default/locale; then
. $DEFLOCDIR/pt_BR
else
. $DEFLOCDIR/en
fi

PLAYERSLIST="ffplay"
for i in gmplayer kmplayer mpv QMPlay2 rage smplayer totem vlc xine; do
	if [ ! -z $(which $i) ]; then
		PLAYERSLIST="$PLAYERSLIST,$i"
	fi
done

TITLETEXT="Sparky Tube"
TITLETEXTV="Sparky Tube Video"
TITLETEXTA="Sparky Tube Audio"
GUI="yad --center --image-on-top --title="
IMAGE="--window-icon=/usr/share/pixmaps/sparky-tube.png --image=/usr/share/pixmaps/sparky-tube.png"
FORM="--form"
INFO="--info"
PROGRESS="--progress --pulsate --auto-close --no-buttons --auto-kill --text="
PROGRESSTEXT="--progress-text="
FIELD="--field="
TXT="--text="
BUTTONOK="--button=Ok!gtk-ok:0"
SIZE="--width=500"
MUSICSAVEPATH=$(xdg-user-dir MUSIC)
VIDEOSAVEPATH=$(xdg-user-dir VIDEOS)

YOUDOWN=$($GUI"$TITLETEXT" $SIZE $TXT"$LOCAL2" \
$IMAGE $FORM --item-separator="," \
--button=Ok \
$FIELD"<b>URL</b>:" \
$FIELD"$LOCAL14":CBE \
$FIELD"$LOCAL15":CBE \
$FIELD"$LOCAL18":CHK \
"" "audio:mp3,audio:aac,audio:flac,audio:m4a,audio:opus,audio:ogg,audio:wav,video:mp4,video:avi,video:flv,video:mkv,video:ogg" "$PLAYERSLIST")

#url
URL=$(echo $YOUDOWN | cut -d'|' -f1)
#av players
PLAYER=$(echo $YOUDOWN | cut -d'|' -f3)
#audio / video
AVFORMAT=$(echo $YOUDOWN | cut -d'|' -f2 | cut -d: -f1)
#
PLAYFORMAT=$(echo $YOUDOWN | cut -d'|' -f2 | cut -d: -f2)
#play checkbox true/false
PLAY=$(echo $YOUDOWN | cut -d'|' -f4)

_getFileName() {
FILE=$(youtube-dl -o '%(title)s.%(ext)s' --get-filename -s -i "$URL")
}

if echo "$URL" | grep -Eqs '&list' ; then
	$GUI"$TITLETEXT" $IMAGE $SIZE $INFO $TXT"\n$LOCAL19: $LOCAL20\n$LOCAL21" $BUTTONOK
	exit 1
fi

if [ -z $URL ]; then
	$GUI"$TITLETEXT" $IMAGE $SIZE $INFO $TXT"\n$LOCAL16" $BUTTONOK
	exit 1
fi

CHECKURL=$(curl -o /dev/null --silent --head --write-out '%{http_code}' "$URL")

if [ ! $CHECKURL -eq 200 ]; then
	$GUI"$TITLETEXT" $IMAGE $SIZE $INFO $TXT"$LOCAL4" $BUTTONOK
	exit 1
fi

_getFileName

if [ $? = 0 ]; then
	true
else
	$GUI"$TITLETEXT" $IMAGE $SIZE $INFO $TXT"\n$LOCAL19: $LOCAL22" $BUTTONOK
	exit 1
fi

if [ "$PLAYFORMAT" = "avi" ]; then
	VIDEOFORM="bestvideo+bestaudio/best --recode-video avi"
elif [ "$PLAYFORMAT" = "flv" ]; then
	VIDEOFORM="bestvideo+bestaudio/best --recode-video flv"
elif [ "$PLAYFORMAT" = "mkv" ]; then
	VIDEOFORM="bestvideo+bestaudio/best --merge-output-format mkv"
elif [ "$PLAYFORMAT" = "mp4" ]; then
	VIDEOFORM="bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best --merge-output-format mp4"
elif [ "$PLAYFORMAT" = "ogg" ]; then
	VIDEOFORM="bestvideo+bestaudio/best --recode-video ogg"
else
	VIDEOFORM="best"
fi

if [ "$AVFORMAT" = "audio" ]; then
	cd $MUSICSAVEPATH
	youtube-dl -o '%(title)s.%(ext)s' --extract-audio --audio-format $PLAYFORMAT --audio-quality 0 $URL | BAR=$($GUI"$TITLETEXTA" $IMAGE $SIZE $PROGRESS"\n$LOCAL5\n$MUSICSAVEPATH\n\n$LOCAL23\n${FILE%.*}.$PLAYFORMAT\n" $PROGRESSTEXT"$LOCAL17")
fi

if [ "$AVFORMAT" = "video" ]; then
	cd $VIDEOSAVEPATH
	youtube-dl -f $VIDEOFORM -o '%(title)s.%(ext)s' $URL | BAR=$($GUI"$TITLETEXTV" $IMAGE $SIZE $PROGRESS"\n$LOCAL5\n$VIDEOSAVEPATH\n\n$LOCAL23\n${FILE%.*}.$PLAYFORMAT\n" $PROGRESSTEXT"$LOCAL17")
fi

if [ "$PLAY" = "TRUE" ]; then
	$PLAYER "${FILE%.*}.$PLAYFORMAT"
fi

if [ "$PLAY" = "FALSE" ]; then
	if [ "$AVFORMAT" = "audio" ]; then
		$GUI"$TITLETEXT" $IMAGE $SIZE $INFO $TXT"${FILE%.*}.$PLAYFORMAT\n$LOCAL11" $BUTTONOK
	else
		$GUI"$TITLETEXT" $IMAGE $SIZE $INFO $TXT"${FILE%.*}.$PLAYFORMAT\n$LOCAL6" $BUTTONOK
	fi
fi

exit 0
