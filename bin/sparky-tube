#!/bin/bash

# Create by Elton 2019/01/24
# Added a patch of MUSIC & VIDEO dirs by Sajmon
# Added getFileName function by Sajmon
# rewritten by Sajmon 2019/03/02
# Last update 2019/02/13
# License: GNU GPL 3 

# get default's locale file
DEFLOCDIR="/usr/share/sparky/sparky-tube"
if grep -Eqs 'de' /etc/default/locale; then
. $DEFLOCDIR/de
elif grep -Eqs 'fr' /etc/default/locale; then
. $DEFLOCDIR/fr  
elif grep -Eqs 'pl' /etc/default/locale; then
. $DEFLOCDIR/pl
elif grep -Eqs 'pt_BR' /etc/default/locale; then
. $DEFLOCDIR/pt_BR
else
. $DEFLOCDIR/en
fi

PLAYERSLIST="ffplay"
for i in gmplayer kmplayer mpv QMPlay2 rage smplayer totem vlc xine; do
	if [ ! -z $(which $i) ]; then
		PLAYERSLIST="$PLAYERSLIST,$i"
	fi
done

TITLETEXT="Sparky Tube"
TITLETEXTV="Sparky Tube Video"
TITLETEXTA="Sparky Tube Audio"
GUI="yad --center --image-on-top --title="
IMAGEA="--window-icon=multimedia-audio-player --image=multimedia-audio-player"
IMAGEV="--window-icon=multimedia-video-player --image=multimedia-video-player"
IMAGETUBE="--window-icon=download --image=download"
FORM="--form"
INFO="--info"
PROGRESS="--progress --pulsate --auto-close --no-buttons --auto-kill --text="
PROGRESSTEXT="--progress-text="
FIELD="--field="
TXT="--text="
BUTTONOK="--button=Ok!gtk-ok:0"
BTNPLAY="--button=$LOCAL9!gtk-ok:0 --button=$LOCAL10!cancel:1"
FILEAUDIO="--file"
FILEVIDEO="--file"
SIZEW="--width=450"
SIZEM="--width=500 --height=250"
SIZEDIR="--width=850 --height=600"
MUSICSAVEPATH=$(xdg-user-dir MUSIC)
VIDEOSAVEPATH=$(xdg-user-dir VIDEOS)


YOUDOWN=$($GUI"$TITLETEXT" $SIZEM $TXT"$LOCAL2" \
$IMAGETUBE $FORM --item-separator="," \
--button=Ok \
$FIELD"<b>URL</b>:" \
$FIELD"$LOCAL14":CBE \
$FIELD"$LOCAL15":CBE \
$FIELD"$LOCAL18":CHK \
"" "audio:mp3,audio:aac,audio:flac,audio:m4a,audio:opus,audio:ogg,audio:wav,video:mp4,video:avi,video:flv,video:mkv,video:ogg" "$PLAYERSLIST")

#url
URL=$(echo $YOUDOWN | cut -d'|' -f1)
#av players
PLAYER=$(echo $YOUDOWN | cut -d'|' -f3)
#audio / video
AVFORMAT=$(echo $YOUDOWN | cut -d'|' -f2 | cut -d: -f1)
#
PLAYFORMAT=$(echo $YOUDOWN | cut -d'|' -f2 | cut -d: -f2)
#play checkbox true/false
PLAY=$(echo $YOUDOWN | cut -d'|' -f4)

getFileName() {
FILE=$(youtube-dl -o '%(title)s.%(ext)s' --get-filename $URL)
}

if [ -z $URL ]; then
	$GUI"$TITLETEXT" $IMAGETUBE $SIZEW $INFO $TXT"$LOCAL16" $BUTTONOK
	exit 1
fi

CHECKURL=$(curl -o /dev/null --silent --head --write-out '%{http_code}' "$URL")

if [ ! $CHECKURL -eq 200 ]; then
	$GUI"$TITLETEXT" $IMAGETUBE $SIZEW $INFO $TXT"$LOCAL4" $BUTTONOK
	exit 1
fi

if [ "$PLAYFORMAT" = "avi" ]; then
	VIDEOFORM="bestvideo+bestaudio/best --recode-video avi"
elif [ "$PLAYFORMAT" = "flv" ]; then
	VIDEOFORM="bestvideo+bestaudio/best --recode-video flv"
elif [ "$PLAYFORMAT" = "mkv" ]; then
	VIDEOFORM="bestvideo+bestaudio/best --merge-output-format mkv"
elif [ "$PLAYFORMAT" = "mp4" ]; then
	VIDEOFORM="bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best --merge-output-format mp4"
elif [ "$PLAYFORMAT" = "ogg" ]; then
	VIDEOFORM="bestvideo+bestaudio/best --recode-video ogg"
else
	VIDEOFORM="best"
fi

if [ $AVFORMAT = "audio" ]; then
	cd $MUSICSAVEPATH
	youtube-dl -o '%(title)s.%(ext)s' --extract-audio --audio-format $PLAYFORMAT --audio-quality 0 $URL | BAR=$($GUI"$TITLETEXTA" $IMAGEA $SIZEW $PROGRESS"$MUSICSAVEPATH\n$LOCAL5" $PROGRESSTEXT"$LOCAL17")
	if [ $PLAY = "TRUE" ]; then
		getFileName
		$PLAYER "${FILE%.*}.$PLAYFORMAT"
		exit 0
	fi
fi

if [ $AVFORMAT = "video" ]; then
	cd $VIDEOSAVEPATH
	youtube-dl -f $VIDEOFORM -o '%(title)s.%(ext)s' $URL | BAR=$($GUI"$TITLETEXTV" $IMAGEV $SIZEW $PROGRESS"$VIDEOSAVEPATH\n$LOCAL5" $PROGRESSTEXT"$LOCAL17")
	if [ $PLAY = "TRUE" ]; then
		getFileName
		$PLAYER "${FILE%.*}.$PLAYFORMAT"
		exit 0
	fi
fi

exit 0
